{% extends 'base/main.html' %}

{% block title %}{{ room.name }} Calendar{% endblock %}

{% block content %}
<div class="container">
    <!-- Room Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">{{ room.name }} Calendar</h2>
            <p class="text-secondary mb-0">
                <i class="fas fa-tag me-1"></i> {{ room.topic.name|default:"No Topic" }} | 
                <i class="fas fa-users me-1"></i> Capacity: {{ room.capacity }}
            </p>
        </div>
        <div>
            <a href="{% url 'room' room.id %}" class="btn btn-outline-primary me-2">
                <i class="fas fa-info-circle me-1"></i> Room Details
            </a>
            <a href="{% url 'create-reservation' room.id %}" class="btn btn-primary">
                <i class="fas fa-calendar-plus me-1"></i> New Reservation
            </a>
        </div>
    </div>

    <!-- Calendar Navigation -->
    <div class="calendar-nav d-flex justify-content-between align-items-center mb-4">
        <a href="?start_date={{ prev_week }}" class="btn btn-outline-secondary">
            <i class="fas fa-chevron-left me-1"></i> Previous Week
        </a>
        <h5 class="mb-0">{{ dates.0|date:"M d" }} - {{ dates.6|date:"M d, Y" }}</h5>
        <div>
            <a href="?start_date={{ today }}" class="btn btn-outline-secondary me-2">Today</a>
            <a href="?start_date={{ next_week }}" class="btn btn-outline-secondary">
                Next Week <i class="fas fa-chevron-right ms-1"></i>
            </a>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid">
        <div class="row mb-2">
            {% for date in dates %}
            <div class="col">
                <div class="calendar-header text-center p-2 {% if date == today %}bg-accent bg-opacity-25{% endif %}">
                    <div class="calendar-day-name">{{ date|date:"D" }}</div>
                    <div class="calendar-date">{{ date|date:"d" }}</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Time slots from 8 AM to 6 PM -->
        {% for hour in "89101112131415161718"|make_list %}
        <div class="row mb-1">
            <div class="col-1 time-label text-end pe-2 py-2">
                {% if hour == "8" %}
                8 AM
                {% elif hour == "9" %}
                9 AM
                {% elif hour == "10" %}
                10 AM
                {% elif hour == "11" %}
                11 AM
                {% elif hour == "12" %}
                12 PM
                {% elif hour == "13" %}
                1 PM
                {% elif hour == "14" %}
                2 PM
                {% elif hour == "15" %}
                3 PM
                {% elif hour == "16" %}
                4 PM
                {% elif hour == "17" %}
                5 PM
                {% elif hour == "18" %}
                6 PM
                {% endif %}
            </div>
            {% for date in dates %}
            <div class="col">
                <div class="calendar-slot p-2 {% if date == today %}today{% endif %}">
                    {% with hour_int=hour|add:"0" %}
                    {% with next_hour=hour_int|add:"1" %}
                    {% with start_time=hour_int|stringformat:"02d"|add:":00" %}
                    {% with end_time=next_hour|stringformat:"02d"|add:":00" %}
                    
                    {% with slot_booked=False %}
                    {% for reservation in reservations_by_date|get_item:date %}
                        {% if reservation.start_time|time:"H:i" <= start_time and reservation.end_time|time:"H:i" >= end_time %}
                            {% with slot_booked=True %}
                            <div class="booked-slot" data-bs-toggle="tooltip" data-bs-placement="top" 
                                 title="{{ reservation.title }} ({{ reservation.start_time|time:"g:i A" }} - {{ reservation.end_time|time:"g:i A" }})">
                                <div class="small text-truncate">{{ reservation.title }}</div>
                                <div class="smaller text-secondary">{{ reservation.user.username }}</div>
                            </div>
                            {% endwith %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if not slot_booked %}
                        <a href="{% url 'create-reservation' room.id %}?date={{ date|date:'Y-m-d' }}&start_time={{ start_time }}&end_time={{ end_time }}" 
                           class="empty-slot d-block h-100">
                            <span class="visually-hidden">Book {{ date|date:"M d" }} at {{ hour_int|time:"g A" }}</span>
                        </a>
                    {% endif %}
                    {% endwith %}
                    
                    {% endwith %}
                    {% endwith %}
                    {% endwith %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>

    <!-- Legend -->
    <div class="mt-4 d-flex justify-content-end">
        <div class="me-3">
            <span class="legend-item available"></span> Available
        </div>
        <div>
            <span class="legend-item booked"></span> Booked
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .calendar-grid {
        border-radius: 8px;
        overflow: hidden;
        background-color: var(--card-bg);
    }
    
    .calendar-header {
        background-color: var(--darker-bg);
        border-bottom: 1px solid #333;
    }
    
    .calendar-day-name {
        font-weight: 500;
        color: var(--text-secondary);
    }
    
    .calendar-date {
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .time-label {
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .calendar-slot {
        height: 60px;
        border-top: 1px solid #333;
        border-left: 1px solid #333;
        position: relative;
        overflow: hidden;
    }
    
    .calendar-slot:last-child {
        border-right: 1px solid #333;
    }
    
    .row:last-child .calendar-slot {
        border-bottom: 1px solid #333;
    }
    
    .calendar-slot.today {
        background-color: rgba(126, 87, 194, 0.05);
    }
    
    .booked-slot {
        background-color: rgba(207, 102, 121, 0.2);
        color: var(--danger);
        height: 100%;
        padding: 5px;
        border-radius: 4px;
        cursor: default;
    }
    
    .empty-slot {
        background-color: rgba(3, 218, 198, 0.05);
        height: 100%;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .empty-slot:hover {
        background-color: rgba(3, 218, 198, 0.2);
        text-decoration: none;
    }
    
    .smaller {
        font-size: 0.75rem;
    }
    
    .legend-item {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 4px;
        margin-right: 5px;
        vertical-align: middle;
    }
    
    .legend-item.available {
        background-color: rgba(3, 218, 198, 0.2);
    }
    
    .legend-item.booked {
        background-color: rgba(207, 102, 121, 0.2);
    }
</style>
{% endblock %} 