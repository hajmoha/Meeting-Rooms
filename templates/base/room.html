{% extends 'base/main.html' %}

{% block title %}{{ room.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Room Details -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h2 class="card-title mb-1">{{ room.name }}</h2>
                            <p class="text-secondary mb-0">
                                <i class="fas fa-tag me-1"></i> {{ room.topic.name|default:"No Topic" }} | 
                                <i class="fas fa-users me-1"></i> Capacity: {{ room.capacity }}
                            </p>
                        </div>
                        <div>
                            {% if request.user == room.host %}
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="roomActions" data-bs-toggle="dropdown">
                                        <i class="fas fa-cog me-1"></i> Manage
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end" aria-labelledby="roomActions">
                                        <li>
                                            <a class="dropdown-item" href="{% url 'update-room' room.id %}">
                                                <i class="fas fa-edit me-2"></i> Edit Room
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item text-danger" href="{% url 'delete-room' room.id %}">
                                                <i class="fas fa-trash-alt me-2"></i> Delete Room
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="room-features mb-3">
                        {% if room.has_projector %}
                            <span class="room-feature">
                                <i class="fas fa-projector me-1"></i> Projector
                            </span>
                        {% endif %}
                        
                        {% if room.has_whiteboard %}
                            <span class="room-feature">
                                <i class="fas fa-chalkboard me-1"></i> Whiteboard
                            </span>
                        {% endif %}
                        
                        {% if room.has_video_conference %}
                            <span class="room-feature">
                                <i class="fas fa-video me-1"></i> Video Conference
                            </span>
                        {% endif %}
                    </div>
                    
                    <div class="room-description mb-4">
                        <h5>Description</h5>
                        <p class="mb-0">{{ room.description|linebreaks }}</p>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="host-info">
                            <p class="mb-0 small text-secondary">
                                <i class="fas fa-user me-1"></i> Hosted by: {{ room.host.username }}
                            </p>
                            <p class="mb-0 small text-secondary">
                                <i class="fas fa-clock me-1"></i> Created: {{ room.created|date:"M d, Y" }}
                            </p>
                        </div>
                        
                        {% if request.user.is_authenticated %}
                            <div class="d-flex">
                                <a href="{% url 'room-calendar' room.id %}" class="btn btn-outline-primary me-2">
                                    <i class="fas fa-calendar-alt me-1"></i> View Calendar
                                </a>
                                <a href="{% url 'create-reservation' room.id %}" class="btn btn-primary">
                                    <i class="fas fa-calendar-plus me-1"></i> Reserve
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Upcoming Reservations -->
            <div class="card mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Upcoming Reservations</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for reservation in upcoming_reservations %}
                            <div class="list-group-item bg-transparent">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">{{ reservation.title }}</h6>
                                        <p class="mb-0 small text-secondary">
                                            <i class="far fa-calendar me-1"></i> {{ reservation.date|date:"M d, Y" }} 
                                            <i class="far fa-clock ms-2 me-1"></i> {{ reservation.start_time|time:"g:i A" }} - {{ reservation.end_time|time:"g:i A" }}
                                        </p>
                                    </div>
                                    <span class="badge bg-secondary">{{ reservation.user.username }}</span>
                                </div>
                            </div>
                        {% empty %}
                            <div class="list-group-item bg-transparent text-center py-4">
                                <p class="text-secondary mb-0">No upcoming reservations for this room</p>
                                {% if request.user.is_authenticated %}
                                    <a href="{% url 'create-reservation' room.id %}" class="btn btn-sm btn-primary mt-2">
                                        <i class="fas fa-calendar-plus me-1"></i> Reserve Now
                                    </a>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% if upcoming_reservations %}
                    <div class="card-footer bg-transparent text-center">
                        <a href="{% url 'room-calendar' room.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-calendar-alt me-1"></i> View Full Calendar
                        </a>
                    </div>
                {% endif %}
            </div>
            
            <!-- Discussion -->
            <div class="card">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Discussion</h5>
                </div>
                <div class="card-body">
                    {% if request.user.is_authenticated %}
                        <form method="POST" action="" class="mb-4">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="body" class="form-label">Add a message</label>
                                <textarea name="body" id="body" class="form-control" rows="3" placeholder="Share your thoughts about this room..."></textarea>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i> Post
                                </button>
                            </div>
                        </form>
                    {% else %}
                        <div class="alert alert-secondary">
                            <p class="mb-0">Please <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">login</a> to join the discussion.</p>
                        </div>
                    {% endif %}
                    
                    <div class="messages">
                        {% for message in room_messages %}
                            <div class="message mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <h6 class="mb-0">{{ message.user.username }}</h6>
                                    <div class="d-flex align-items-center">
                                        <small class="text-secondary me-2">{{ message.created|date:"M d, Y" }} at {{ message.created|time:"g:i A" }}</small>
                                        {% if request.user == message.user %}
                                            <a href="{% url 'delete-message' message.id %}" class="btn btn-sm btn-outline-danger btn-icon">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                                <p class="mb-0">{{ message.body }}</p>
                            </div>
                            {% if not forloop.last %}
                                <hr class="my-3" style="border-color: #333;">
                            {% endif %}
                        {% empty %}
                            <div class="text-center py-4">
                                <i class="far fa-comment-dots fa-3x mb-3 text-secondary"></i>
                                <h5>No messages yet</h5>
                                <p class="text-secondary">Be the first to start a discussion about this room</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Participants -->
            <div class="card mb-4">
                <div class="card-header bg-transparent">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i>Participants</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for user in participants %}
                            <div class="list-group-item bg-transparent d-flex align-items-center">
                                <div class="avatar me-3">
                                    <i class="fas fa-user-circle fa-2x text-secondary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">{{ user.username }}</h6>
                                    {% if user == room.host %}
                                        <span class="badge bg-accent">Host</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% empty %}
                            <div class="list-group-item bg-transparent text-center py-4">
                                <p class="text-secondary mb-0">No participants yet</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Quick Reservation -->
            {% if request.user.is_authenticated %}
                <div class="card">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0"><i class="fas fa-calendar-plus me-2"></i>Quick Reserve</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-secondary mb-3">Select a date to see available time slots:</p>
                        <div class="mb-3">
                            <input type="date" id="quickReserveDate" class="form-control" min="{{ today|date:'Y-m-d' }}">
                        </div>
                        <div id="availableSlots" class="d-none">
                            <h6 class="mb-2">Available Time Slots:</h6>
                            <div class="time-slots">
                                <!-- Time slots will be populated by JavaScript -->
                            </div>
                        </div>
                        <div id="noSlotsMessage" class="d-none">
                            <p class="text-secondary">No available time slots for this date.</p>
                        </div>
                        <div class="text-center mt-3">
                            <a href="{% url 'create-reservation' room.id %}" class="btn btn-outline-primary">
                                <i class="fas fa-calendar-alt me-1"></i> Advanced Booking
                            </a>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.getElementById('quickReserveDate');
        const availableSlots = document.getElementById('availableSlots');
        const noSlotsMessage = document.getElementById('noSlotsMessage');
        const timeSlotsContainer = document.querySelector('.time-slots');
        
        if (dateInput) {
            // Set default date to today
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
            
            // Sample time slots (in a real app, you'd fetch these from the server)
            const sampleTimeSlots = [
                { start: '09:00', end: '10:00' },
                { start: '10:00', end: '11:00' },
                { start: '11:00', end: '12:00' },
                { start: '13:00', end: '14:00' },
                { start: '14:00', end: '15:00' },
                { start: '15:00', end: '16:00' },
                { start: '16:00', end: '17:00' }
            ];
            
            // Display time slots
            function displayTimeSlots(slots) {
                timeSlotsContainer.innerHTML = '';
                
                if (slots.length === 0) {
                    availableSlots.classList.add('d-none');
                    noSlotsMessage.classList.remove('d-none');
                    return;
                }
                
                availableSlots.classList.remove('d-none');
                noSlotsMessage.classList.add('d-none');
                
                slots.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.className = 'time-slot';
                    
                    // Format times for display
                    const startTime = formatTime(slot.start);
                    const endTime = formatTime(slot.end);
                    
                    slotElement.innerHTML = `
                        <a href="{% url 'create-reservation' room.id %}?date=${dateInput.value}&start_time=${slot.start}&end_time=${slot.end}" 
                           class="btn btn-sm btn-outline-success mb-2 me-2">
                            ${startTime} - ${endTime}
                        </a>
                    `;
                    
                    timeSlotsContainer.appendChild(slotElement);
                });
            }
            
            // Format time from 24h to 12h format
            function formatTime(time) {
                const [hours, minutes] = time.split(':');
                const hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${minutes} ${ampm}`;
            }
            
            // Initial display
            displayTimeSlots(sampleTimeSlots);
            
            // Update when date changes
            dateInput.addEventListener('change', function() {
                // In a real app, you'd fetch available slots from the server based on the date
                // For this demo, we'll just show the sample slots
                displayTimeSlots(sampleTimeSlots);
            });
        }
    });
</script>
{% endblock %}
